<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BasketFlow - Video Merge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #a0aec0;
            margin-bottom: 30px;
        }

        .status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 80px;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .status-text {
            color: #e2e8f0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            width: 0%;
            transition: width 0.3s;
        }

        .success {
            color: #48bb78;
        }

        .error {
            color: #fc8181;
        }

        .footer {
            color: #718096;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé¨ Video Merge</h1>
        <p class="subtitle">BasketFlow Studio</p>

        <div class="status">
            <div class="status-icon" id="icon">‚è≥</div>
            <div class="status-text" id="status">Waiting for merge request from extension...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>

        <p class="footer">
            This page merges videos using FFmpeg.wasm<br>
            Window will close automatically when complete
        </p>
    </div>

    <script type="module">
        import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js';
        import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

        const $ = (sel) => document.querySelector(sel);

        function updateStatus(icon, text, progress = null) {
            $('#icon').textContent = icon;
            $('#status').textContent = text;
            if (progress !== null) {
                $('#progress').style.width = progress + '%';
            }
        }

        let ffmpegInstance = null;

        async function loadFFmpeg() {
            if (ffmpegInstance) return ffmpegInstance;

            updateStatus('üì•', 'Loading FFmpeg (~32MB)...', 10);

            const ffmpeg = new FFmpeg();

            ffmpeg.on('progress', ({ progress }) => {
                updateStatus('üîÑ', `Merging: ${Math.round(progress * 100)}%`, 50 + progress * 40);
            });

            try {
                const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm';
                const workerURL = 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/worker.js';

                console.log('[MERGE_PAGE] Fetching core files as Blobs...');

                const [coreBlob, wasmBlob, workerBlob] = await Promise.all([
                    toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                    toBlobURL(workerURL, 'text/javascript')
                ]);

                console.log('[MERGE_PAGE] Core files fetched. Loading FFmpeg...');

                await ffmpeg.load({
                    coreURL: coreBlob,
                    wasmURL: wasmBlob,
                    classWorkerURL: workerBlob
                });

                console.log('[MERGE_PAGE] FFmpeg loaded successfully');
            } catch (err) {
                console.error('[MERGE_PAGE] FFmpeg load error:', err);
                updateStatus('‚ùå', 'Load Error: ' + err.message, 0);
                throw err;
            }

            ffmpegInstance = ffmpeg;
            updateStatus('‚úÖ', 'FFmpeg loaded!', 30);
            return ffmpeg;
        }

        async function mergeVideos(clip1Base64, clip2Base64) {
            const ffmpeg = await loadFFmpeg();

            updateStatus('üìÇ', 'Preparing videos...', 40);

            const blob1 = await (await fetch(clip1Base64)).blob();
            const blob2 = await (await fetch(clip2Base64)).blob();

            console.log(`Part 1: ${(blob1.size / 1024 / 1024).toFixed(2)} MB`);
            console.log(`Part 2: ${(blob2.size / 1024 / 1024).toFixed(2)} MB`);

            await ffmpeg.writeFile('input0.mp4', await fetchFile(blob1));
            await ffmpeg.writeFile('input1.mp4', await fetchFile(blob2));

            const list = 'file input0.mp4\nfile input1.mp4';
            await ffmpeg.writeFile('list.txt', new TextEncoder().encode(list));

            updateStatus('üîÑ', 'Merging videos...', 50);

            await ffmpeg.exec([
                '-f', 'concat', '-safe', '0', '-i', 'list.txt',
                '-c', 'copy', '-movflags', '+faststart', 'output.mp4'
            ]);

            const data = await ffmpeg.readFile('output.mp4');

            await ffmpeg.deleteFile('input0.mp4');
            await ffmpeg.deleteFile('input1.mp4');
            await ffmpeg.deleteFile('list.txt');
            await ffmpeg.deleteFile('output.mp4');

            updateStatus('üì§', 'Finalizing...', 95);

            const outputBlob = new Blob([new Uint8Array(data.buffer)], { type: 'video/mp4' });
            console.log(`Merged: ${(outputBlob.size / 1024 / 1024).toFixed(2)} MB`);

            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(outputBlob);
                reader.onloadend = () => resolve(reader.result);
            });

            return base64;
        }

        window.addEventListener('message', async (event) => {
            if (event.data?.type === 'BRIDGE_READY') {
                console.log('[MERGE_PAGE] Bridge ready!');
                window.postMessage({ type: 'MERGE_PAGE_READY' }, '*');
            }

            if (event.data?.type === 'MERGE_REQUEST') {
                const { requestId, clip1Base64, clip2Base64 } = event.data;
                console.log('[MERGE_PAGE] Received merge request:', requestId);

                try {
                    const result = await mergeVideos(clip1Base64, clip2Base64);
                    updateStatus('‚úÖ', 'Merge complete!', 100);
                    window.postMessage({ type: 'MERGE_RESPONSE', requestId, ok: true, dataURL: result }, '*');
                    setTimeout(() => window.close(), 3000);
                } catch (error) {
                    console.error('[MERGE_PAGE] Error:', error);
                    updateStatus('‚ùå', 'Error: ' + error.message, 0);
                    $('#status').classList.add('error');
                    window.postMessage({ type: 'MERGE_RESPONSE', requestId, ok: false, error: error.message }, '*');
                }
            }
        });

        updateStatus('üëç', 'Ready! Waiting for merge request...', 5);
        window.postMessage({ type: 'MERGE_PAGE_READY' }, '*');
        console.log('[MERGE_PAGE] Initialized and ready');
    </script>
</body>

</html>